name: Build

on:
  push:
    branches: [ main, master, develop, claude/** ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-linux:
    name: Build on Linux (FPC)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install FPC and Lazarus
      run: |
        sudo apt-get update
        sudo apt-get install -y fpc lazarus lcl-gtk2-3.0 lcl-units-3.0

    - name: Install PortAudio
      run: |
        sudo apt-get install -y libportaudio2 portaudio19-dev

    - name: Display FPC version
      run: fpc -iV

    - name: Build Sine Generator
      run: |
        cd "Demos/Sine Generator"
        fpc -Fu../../Source \
            -Fu/usr/lib/lazarus/3.0/lcl/units/x86_64-linux \
            -Fu/usr/lib/lazarus/3.0/lcl/units/x86_64-linux/gtk2 \
            -Fu/usr/lib/lazarus/3.0/components/lazutils/lib/x86_64-linux \
            -Fi/usr/lib/lazarus/3.0/lcl/include \
            -dLCL -dLCLgtk2 \
            SineGenerator.dpr

    - name: Build Noise Generator
      run: |
        cd "Demos/Noise Generator"
        fpc -Fu../../Source \
            -Fu/usr/lib/lazarus/3.0/lcl/units/x86_64-linux \
            -Fu/usr/lib/lazarus/3.0/lcl/units/x86_64-linux/gtk2 \
            -Fu/usr/lib/lazarus/3.0/components/lazutils/lib/x86_64-linux \
            -Fi/usr/lib/lazarus/3.0/lcl/include \
            -dLCL -dLCLgtk2 \
            NoiseGenerator.dpr

    - name: Build VU Meter
      run: |
        cd "Demos/VU Meter"
        fpc -Fu../../Source \
            -Fu/usr/lib/lazarus/3.0/lcl/units/x86_64-linux \
            -Fu/usr/lib/lazarus/3.0/lcl/units/x86_64-linux/gtk2 \
            -Fu/usr/lib/lazarus/3.0/components/lazutils/lib/x86_64-linux \
            -Fi/usr/lib/lazarus/3.0/lcl/include \
            -dLCL -dLCLgtk2 \
            VUMeter.dpr

    - name: Build Effect Generator
      run: |
        cd "Demos/Effect Generator"
        fpc -Fu../../Source \
            -Fu/usr/lib/lazarus/3.0/lcl/units/x86_64-linux \
            -Fu/usr/lib/lazarus/3.0/lcl/units/x86_64-linux/gtk2 \
            -Fu/usr/lib/lazarus/3.0/components/lazutils/lib/x86_64-linux \
            -Fi/usr/lib/lazarus/3.0/lcl/include \
            -dLCL -dLCLgtk2 \
            EffectGenerator.dpr

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: linux-binaries
        path: |
          Demos/*/SineGenerator
          Demos/*/NoiseGenerator
          Demos/*/VUMeter
          Demos/*/EffectGenerator
        retention-days: 7

  build-windows:
    name: Build on Windows (FPC)
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install FPC and Lazarus
      run: |
        choco install lazarus --version=3.0.0 -y

    - name: Add FPC to PATH
      run: |
        echo "C:\lazarus\fpc\3.2.2\bin\x86_64-win64" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh

    - name: Display FPC version
      run: fpc -iV
      shell: cmd

    - name: Build Sine Generator
      run: |
        cd "Demos\Sine Generator"
        fpc -Fu..\..\Source -Fu"C:\lazarus\lcl\units\x86_64-win64" -Fu"C:\lazarus\lcl\units\x86_64-win64\win32" -Fu"C:\lazarus\components\lazutils\lib\x86_64-win64" -Fi"C:\lazarus\lcl\include" -dLCL -dLCLwin32 SineGenerator.dpr
      shell: cmd

    - name: Build Noise Generator
      run: |
        cd "Demos\Noise Generator"
        fpc -Fu..\..\Source -Fu"C:\lazarus\lcl\units\x86_64-win64" -Fu"C:\lazarus\lcl\units\x86_64-win64\win32" -Fu"C:\lazarus\components\lazutils\lib\x86_64-win64" -Fi"C:\lazarus\lcl\include" -dLCL -dLCLwin32 NoiseGenerator.dpr
      shell: cmd

    - name: Build VU Meter
      run: |
        cd "Demos\VU Meter"
        fpc -Fu..\..\Source -Fu"C:\lazarus\lcl\units\x86_64-win64" -Fu"C:\lazarus\lcl\units\x86_64-win64\win32" -Fu"C:\lazarus\components\lazutils\lib\x86_64-win64" -Fi"C:\lazarus\lcl\include" -dLCL -dLCLwin32 VUMeter.dpr
      shell: cmd

    - name: Build Effect Generator
      run: |
        cd "Demos\Effect Generator"
        fpc -Fu..\..\Source -Fu"C:\lazarus\lcl\units\x86_64-win64" -Fu"C:\lazarus\lcl\units\x86_64-win64\win32" -Fu"C:\lazarus\components\lazutils\lib\x86_64-win64" -Fi"C:\lazarus\lcl\include" -dLCL -dLCLwin32 EffectGenerator.dpr
      shell: cmd

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: windows-binaries
        path: |
          Demos\*\*.exe
        retention-days: 7

  build-macos:
    name: Build on macOS (FPC)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Lazarus
      uses: gcarreno/setup-lazarus@v3
      with:
        lazarus-version: "3.0"
        with-cache: true

    - name: Install PortAudio
      run: |
        brew install portaudio

    - name: Display FPC version
      run: fpc -iV

    - name: Detect architecture and set variables
      id: arch
      run: |
        ARCH=$(uname -m)
        if [ "$ARCH" = "arm64" ]; then
          echo "fpc_arch=aarch64" >> $GITHUB_OUTPUT
          echo "darwin_arch=aarch64-darwin" >> $GITHUB_OUTPUT
        else
          echo "fpc_arch=x86_64" >> $GITHUB_OUTPUT
          echo "darwin_arch=x86_64-darwin" >> $GITHUB_OUTPUT
        fi
        echo "Detected architecture: $ARCH"

    - name: Find Lazarus paths
      id: lazarus_paths
      run: |
        # Find Lazarus installation directory
        if [ -d "/usr/local/share/lazarus" ]; then
          LAZARUS_DIR="/usr/local/share/lazarus"
        elif [ -d "$HOME/.lazarus" ]; then
          LAZARUS_DIR="$HOME/.lazarus"
        elif [ -d "/Applications/Lazarus" ]; then
          LAZARUS_DIR="/Applications/Lazarus"
        else
          # Try to find where lazbuild is
          LAZBUILD_PATH=$(which lazbuild)
          if [ -n "$LAZBUILD_PATH" ]; then
            LAZARUS_DIR=$(dirname $(dirname $LAZBUILD_PATH))
          else
            echo "Error: Could not find Lazarus installation"
            exit 1
          fi
        fi
        echo "lazarus_dir=$LAZARUS_DIR" >> $GITHUB_OUTPUT
        echo "Found Lazarus at: $LAZARUS_DIR"

        # List directory structure for debugging
        ls -la "$LAZARUS_DIR" || true
        ls -la "$LAZARUS_DIR/lcl/units" || true

    - name: Build Sine Generator
      run: |
        cd "Demos/Sine Generator"
        lazbuild --add-package-link ${{ steps.lazarus_paths.outputs.lazarus_dir }}/components/lazutils/lazutils.lpk
        fpc -Fu../../Source \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/units/${{ steps.arch.outputs.darwin_arch }} \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/units/${{ steps.arch.outputs.darwin_arch }}/cocoa \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/components/lazutils/lib/${{ steps.arch.outputs.darwin_arch }} \
            -Fi${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/include \
            -dLCL -dLCLcocoa \
            SineGenerator.dpr

    - name: Build Noise Generator
      run: |
        cd "Demos/Noise Generator"
        fpc -Fu../../Source \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/units/${{ steps.arch.outputs.darwin_arch }} \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/units/${{ steps.arch.outputs.darwin_arch }}/cocoa \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/components/lazutils/lib/${{ steps.arch.outputs.darwin_arch }} \
            -Fi${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/include \
            -dLCL -dLCLcocoa \
            NoiseGenerator.dpr

    - name: Build VU Meter
      run: |
        cd "Demos/VU Meter"
        fpc -Fu../../Source \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/units/${{ steps.arch.outputs.darwin_arch }} \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/units/${{ steps.arch.outputs.darwin_arch }}/cocoa \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/components/lazutils/lib/${{ steps.arch.outputs.darwin_arch }} \
            -Fi${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/include \
            -dLCL -dLCLcocoa \
            VUMeter.dpr

    - name: Build Effect Generator
      run: |
        cd "Demos/Effect Generator"
        fpc -Fu../../Source \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/units/${{ steps.arch.outputs.darwin_arch }} \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/units/${{ steps.arch.outputs.darwin_arch }}/cocoa \
            -Fu${{ steps.lazarus_paths.outputs.lazarus_dir }}/components/lazutils/lib/${{ steps.arch.outputs.darwin_arch }} \
            -Fi${{ steps.lazarus_paths.outputs.lazarus_dir }}/lcl/include \
            -dLCL -dLCLcocoa \
            EffectGenerator.dpr

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: macos-binaries
        path: |
          Demos/*/SineGenerator
          Demos/*/NoiseGenerator
          Demos/*/VUMeter
          Demos/*/EffectGenerator
        retention-days: 7
